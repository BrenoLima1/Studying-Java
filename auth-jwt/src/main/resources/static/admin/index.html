<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 40px auto; }
    h1 { margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    button { padding: 8px 12px; margin-top: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>

  <p id="welcome"></p>

  <button id="list-users-btn">List all users</button>

  <table id="users-table" class="hidden">
    <thead>
      <tr><th>ID</th><th>Username</th><th>Role</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="logout-btn">Logout</button>

  <script>
    const welcome = document.getElementById('welcome');
    const listUsersBtn = document.getElementById('list-users-btn');
    const usersTable = document.getElementById('users-table');
    const usersTbody = usersTable.querySelector('tbody');
    const logoutBtn = document.getElementById('logout-btn');

    function getToken() { return localStorage.getItem('token'); }
    function clearToken() {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('username');
    }
    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }

    // Show welcome message
    const username = localStorage.getItem('username');
    const role = localStorage.getItem('role');
    if (username && role) {
      welcome.textContent = `Logged in as: ${username} (${role})`;
    }

    // List users
    listUsersBtn.addEventListener('click', async () => {
      const token = getToken();
      try {
        const res = await fetch('/auth/users', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Failed to fetch users");
        const users = await res.json();

        // Clear previous rows
        while (usersTbody.firstChild) {
          usersTbody.removeChild(usersTbody.firstChild);
        }

        // Build rows safely
        users.forEach(u => {
          const tr = document.createElement('tr');

          const tdId = document.createElement('td');
          tdId.textContent = u.id;

          const tdUsername = document.createElement('td');
          tdUsername.textContent = u.username;

          const tdRole = document.createElement('td');
          tdRole.textContent = u.role;

          tr.appendChild(tdId);
          tr.appendChild(tdUsername);
          tr.appendChild(tdRole);

          usersTbody.appendChild(tr);
        });

        show(usersTable);
      } catch (err) {
        alert(err.message);
      }
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      clearToken();
      window.location.href = "/index.html"; // back to login page
    });
  </script>
</body>
</html>