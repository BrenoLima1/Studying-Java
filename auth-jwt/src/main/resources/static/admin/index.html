<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Admin - Users</title>
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    #pagination { margin-top: 15px; }
    button { margin: 5px; }
  </style>
</head>
<body>
  <h1>Administration Panel</h1>

  <button id="listUsersBtn">List Users</button>

  <table id="usersTable" style="display:none;">
    <thead>
      <tr>
        <th>ID</th>
        <th>User</th>
        <th>Role</th>
      </tr>
    </thead>
    <tbody id="usersTbody"></tbody>
  </table>

  <div id="pagination" style="display:none;">
    <button id="prev-btn">Previous</button>
    <span id="page-info"></span>
    <button id="next-btn">Next</button>
  </div>

<script>
  const usersTable = document.getElementById("usersTable");
  const usersTbody = document.getElementById("usersTbody");
  const listUsersBtn = document.getElementById("listUsersBtn");
  const paginationDiv = document.getElementById("pagination");
  const pageInfo = document.getElementById("page-info");
  const prevBtn = document.getElementById("prev-btn");
  const nextBtn = document.getElementById("next-btn");

  let currentPage = 0;
  const pageSize = 5; 
  let totalPages = 0;

  function getToken() {
    return localStorage.getItem("token"); 
  }

  async function loadUsers(page = 0) {
    const token = getToken();
    try {
      const res = await fetch(`/auth/users?page=${page}&size=${pageSize}`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.ok) throw new Error("Failed to fetch users");

      const data = await res.json();

      // limpa tabela
      while (usersTbody.firstChild) {
        usersTbody.removeChild(usersTbody.firstChild);
      }

     data.content.forEach(u => {
  const tr = document.createElement("tr");

  const tdId = document.createElement("td");
  tdId.textContent = u.id;

  const tdUsername = document.createElement("td");
  tdUsername.textContent = u.username;

  const tdRole = document.createElement("td");
  tdRole.textContent = u.role;

  const tdDelete = document.createElement("td");
  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "Delete";
  deleteBtn.addEventListener("click", async () => {
    try {
      const res = await fetch(`/auth/users/${u.id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error("Deletion failed");
      loadUsers(currentPage);
    } catch (err) {
      alert(err.message);
    }
  });
  tdDelete.appendChild(deleteBtn);

  const tdUpdate = document.createElement("td");
  const updateBtn = document.createElement("button");
  updateBtn.textContent = "Update";
  updateBtn.addEventListener("click", () => {

    window.location.href = `update.html?id=${u.id}`;
  });
  tdUpdate.appendChild(updateBtn);

  tr.appendChild(tdId);
  tr.appendChild(tdUsername);
  tr.appendChild(tdRole);
  tr.appendChild(tdDelete);
  tr.appendChild(tdUpdate);

  usersTbody.appendChild(tr);
});

      usersTable.style.display = "table";
      paginationDiv.style.display = "block";

      currentPage = data.number;
      totalPages = data.totalPages;
      pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages}`;

      prevBtn.disabled = currentPage === 0;
      nextBtn.disabled = currentPage + 1 >= totalPages;

    } catch (err) {
      alert(err.message);
    }
  }

  listUsersBtn.addEventListener("click", () => loadUsers(0));

  prevBtn.addEventListener("click", () => {
    if (currentPage > 0) loadUsers(currentPage - 1);
  });

  nextBtn.addEventListener("click", () => {
    if (currentPage + 1 < totalPages) loadUsers(currentPage + 1);
  });
</script>
</body>
</html>